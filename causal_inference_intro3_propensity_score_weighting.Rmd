---
title: "Causal Inference Introduction3: Propensity Score Weighting"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(weights)
library(knitr)
library(cobalt)
library(WeightIt)
library(survey)
```

## Load the dataset

Datasets

- Paper: Dehejia R H, Wahba S. Causal effects in nonexperimental studies: Reevaluating the evaluation of training programs[J]. Journal of the American statistical Association, 1999, 94(448): 1053-1062. (http://www.uh.edu/~adkugler/Dehejia&Wahba_JASA.pdf)
- Download: http://users.nber.org/~rdehejia/nswdata2.html


```{r load}
# Load the datsets
col.names=c('treat', 'age', 'educ', 'black', 'hispan', 'married', 'nodegree', 're74', 're75', 're78')
dir <- './dataset/nswdata/'
nsw_treated <- fread(paste0(dir, 'nswre74_treated.txt'), col.names = col.names)
nsw_control <- fread(paste0(dir, 'nswre74_control.txt'), col.names = col.names)
cps1_control <- fread(paste0(dir, 'cps3_controls.txt'), col.names = col.names)
cps3_control <- fread(paste0(dir, 'cps3_controls.txt'), col.names = col.names)

# Combine all the datasets
nsw_data_exp <- rbind(nsw_treated, nsw_control)
nsw_data_exp[, dataset := 'NSW-Data-Exp']
nsw_data_obs <- rbind(nsw_treated, cps3_control)
nsw_data_obs[, dataset := 'NSW-Data-Obs']
data <- rbind(nsw_data_exp, nsw_data_obs)
```

Now we define a function that estimates the ATT. We will use it repeatedly.

```{r att_func}
estimate.causal.effect <- function(method.name, unbalance.cnt=0, data, weights) {
  d.w <- svydesign(ids = ~1, weights = weights, data = data)
  fit1 <- svyglm(re78 ~ treat, design = d.w)
  att1 <- round(coef(fit1)["treat"])
  conf1 <- paste0("(", paste0(round(confint(fit1, "treat", 0.95)), collapse = ", "), ")")
  cat("ATT: ", att1, conf1, "\n")
  fit2 <- svyglm(re78 ~ treat + age + educ + black + hispan + married + nodegree + re74 + re75, design = d.w)
  att2 <- round(coef(fit2)["treat"])
  conf2 <- paste0("(", paste0(round(confint(fit2, "treat", 0.95)), collapse = ", "), ")")
  cat("ATT: ", att2, conf2, "\n")
  return(data.table(
    `Method name` = method.name,
    `# Unbalance Var.` = unbalance.cnt,
    `ATT` = att1,
    `95% Conf. Int.` = conf1,
    `ATT` = att2,
    `95% Conf. Int.` = conf2
    ))
}
```

Now we check the balance table of the experimental data. Three out of eight variables are not balanced.

```{r experimental_data}
bal.tab(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
        data = nsw_data_exp, estimand = "ATT", m.threshold = .1)
causal.effect.results.all <- estimate.causal.effect("Ground Truth", 3, nsw_data_exp, rep(1, nrow(nsw_data_exp)))
```

Now we check the balance table of the observational data. Six out of eight variables are not balanced.

```{r observational_data}
bal.tab(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
        data = nsw_data_obs, estimand = "ATT", m.threshold = .1)
```

## Observational Study: Propensity Score Weighting

### WeightIt

In this part, we use the `WeightIt` package to get weights and compute ATT.

```{r ps}
W.out <- weightit(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
        data = nsw_data_obs, estimand = "ATT", method = "ps")
bal.tab(W.out, m.threshold = .1)
unbalance.cnt <- sum(abs(bal.tab(W.out)$Balance$Diff.Adj)>0.1)
causal.effect.results.all <- rbind(
  causal.effect.results.all,
  estimate.causal.effect("ps", unbalance.cnt, nsw_data_obs, get.w(W.out))
)
```

```{r gbm}
W.out <- weightit(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
        data = nsw_data_obs, estimand = "ATT", method = "gbm")
bal.tab(W.out, m.threshold = .1)
unbalance.cnt <- sum(abs(bal.tab(W.out)$Balance$Diff.Adj)>0.1)
causal.effect.results.all <- rbind(
  causal.effect.results.all,
  estimate.causal.effect("gbm", unbalance.cnt, nsw_data_obs, get.w(W.out))
)
```

```{r cbps}
W.out <- weightit(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
        data = nsw_data_obs, estimand = "ATT", method = "cbps")
bal.tab(W.out, m.threshold = .1)
unbalance.cnt <- sum(abs(bal.tab(W.out)$Balance$Diff.Adj)>0.1)
causal.effect.results.all <- rbind(
  causal.effect.results.all,
  estimate.causal.effect("cbps", unbalance.cnt, nsw_data_obs, get.w(W.out))
)
```

```{r ebal}
W.out <- weightit(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
        data = nsw_data_obs, estimand = "ATT", method = "ebal")
bal.tab(W.out, m.threshold = .1)
unbalance.cnt <- sum(abs(bal.tab(W.out)$Balance$Diff.Adj)>0.1)
causal.effect.results.all <- rbind(
  causal.effect.results.all,
  estimate.causal.effect("ebal", unbalance.cnt, nsw_data_obs, get.w(W.out))
)
```

```{r ebcw}
W.out <- weightit(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
        data = nsw_data_obs, estimand = "ATT", method = "ebcw")
bal.tab(W.out, m.threshold = .1)
unbalance.cnt <- sum(abs(bal.tab(W.out)$Balance$Diff.Adj)>0.1)
causal.effect.results.all <- rbind(
  causal.effect.results.all,
  estimate.causal.effect("ebcw", unbalance.cnt, nsw_data_obs, get.w(W.out))
)
```

```{r optweight}
W.out <- weightit(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
        data = nsw_data_obs, estimand = "ATT", method = "optweight")
bal.tab(W.out, m.threshold = .1)
unbalance.cnt <- sum(abs(bal.tab(W.out)$Balance$Diff.Adj)>0.1)
causal.effect.results.all <- rbind(
  causal.effect.results.all,
  estimate.causal.effect("optweight", unbalance.cnt, nsw_data_obs, get.w(W.out))
)
```

```{r}
causal.effect.results.all
```

### WeightIt

In this part, we try to reproduce results of the `WeightIt(method="ps")` command by hand.

```{r ps}
fit <- glm(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75,
           data = nsw_data_obs,
           family = binomial("logit"))
pscore <- fit$fitted.values
nsw_data_obs[, w := treat + (1-treat) *pscore / (1-pscore)]
# ATT by hand:
nsw_data_obs[treat==1, mean(re78)] - nsw_data_obs[treat==0, sum(w*re78)/sum(w)]
# ATT by glm:
glm(re78 ~ treat, data = nsw_data_obs, weights = nsw_data_obs$w)
# Cleanup.
nsw_data_obs$w <- NULL
```
